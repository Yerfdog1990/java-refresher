
---

# Cookie-Based Remember-Me Authentication

---

## Lesson Overview

In this lesson, we focus on **cookie-based Remember-Me authentication** in Spring Security and how it can be **customized beyond the default configuration**.

We build on the basic Remember-Me implementation and explore:

* How Spring Security uses cookies to remember authenticated users
* The internal token structure and its security implications
* Customizing cookie expiration, security, names, and parameters
* How Remember-Me integrates with filters, services, and providers
* Practical effects of these configurations during development and runtime

---

## What Is Remember-Me Authentication?

Remember-Me (also known as **persistent-login authentication**) allows a web application to **remember the identity of a principal between sessions**.

This is typically achieved by:

* Sending a cookie to the browser after successful login
* Detecting that cookie during future visits
* Automatically authenticating the user without requiring credentials again

Spring Security provides the infrastructure and hooks required to support this process.

---

## Remember-Me Implementations in Spring Security

Spring Security provides **two concrete Remember-Me implementations**:

1. **Cookie-based (hash-based token) Remember-Me**
2. **Persistent token Remember-Me (database-backed)**

Both approaches:

* Rely on cookies
* Require a `UserDetailsService`

âš ï¸ If an authentication provider does not use `UserDetailsService` (for example, LDAP), Remember-Me will **not work** unless a `UserDetailsService` bean is present.

---

## Cookie-Based (Hash-Based) Remember-Me Approach

### High-Level Description

In the cookie-based approach:

* A Remember-Me cookie is created after successful authentication
* The cookie contains a cryptographically signed token
* On subsequent requests, Spring Security validates the token and restores authentication

---

## Internal Structure of the Remember-Me Token

The cookie value is a Base64-encoded string composed as follows:

```
base64(
  username + ":" +
  expirationTime + ":" +
  algorithmName + ":" +
  algorithmHex(
    username + ":" +
    expirationTime + ":" +
    password + ":" +
    key
  )
)
```

---

### Token Components Explained

* **username**
  Identifies the user via `UserDetailsService`

* **password**
  Must match the password stored in `UserDetails`

* **expirationTime**
  Timestamp (in milliseconds) indicating when the token expires

* **key**
  A private secret used to prevent token modification

* **algorithmName**
  The algorithm used to generate and verify the token signature

---

### Security Implications

* The token is valid only until the expiration time
* The token is invalidated if:

  * The password changes
  * The username changes
  * The key changes

âš ï¸ **Security Limitation**
If a token is captured, it can be reused from any user agent until it expiresâ€”similar to digest authentication.

Mitigation:

* Changing the userâ€™s password immediately invalidates all issued tokens

For stronger security guarantees, the persistent token approach should be used.

---

## Customizing Cookie-Based Remember-Me (2.1 Customizing Remember-Me)

Spring Security provides several configuration options to customize cookie-based Remember-Me behavior.

---

## Customizing Token Validity Period

```java
.tokenValiditySeconds(604800)
```

### Explanation

* Default token validity: **2 weeks**
* New configured validity: **1 week**
* `604800` seconds = 7 days

This setting controls how long the Remember-Me cookie remains valid before expiring.

---

### Observed Behavior

After login with Remember-Me enabled:

* The cookie expiration date reflects the new 1-week duration
* The browser shows the updated expiration timestamp

---

## Configuring the Remember-Me Key

```java
.key("lssAppKey")
```

### Explanation

* The key is a **private secret**
* Used by Spring Security to:

  * Generate Remember-Me tokens
  * Validate incoming tokens

By explicitly configuring the key:

* Token validation becomes deterministic
* Tokens generated by other applications cannot be reused

---

## Securing the Remember-Me Cookie

```java
.useSecureCookie(true)
```

### Explanation

* Marks the Remember-Me cookie as **Secure**
* The cookie will only be sent over **HTTPS connections**

---

### Important Development Consideration

During local development:

* Applications often run over HTTP
* Secure cookies are **not sent** by the browser

Result:

* The cookie exists in the browser
* But it is ignored and has **no effect**

---

### Practical Observation

* Removing `JSESSIONID` while using a Secure Remember-Me cookie over HTTP
* Results in redirection to the login page
* Because the Remember-Me cookie is never sent to the server

This behavior is expected and correct.

---

## Customizing the Remember-Me Cookie Name

```java
.rememberMeCookieName("sticky-cookie")
```

### Explanation

* Default cookie name: `remember-me`
* New cookie name: `sticky-cookie`

Purpose:

* Avoid exposing internal framework details
* Reduce fingerprinting of Spring Security usage

---

### Side Note

* Old cookies with the default name (`remember-me`) are **not automatically removed**
* They may still exist in the browser
* However, they have **no effect** on authentication

---

## Customizing the Remember-Me Request Parameter

```java
.rememberMeParameter("remember")
```

### Explanation

* Default checkbox parameter name: `remember-me`
* New parameter name: `remember`

Reason:

* Avoid leaking framework defaults
* Maintain consistency with customized backend expectations

---

### Required Frontend Change

The login page must be updated to match the new parameter:

```html
<input type="checkbox" name="remember" />
```

Backend and frontend values must match exactly.

---

## Remember-Me Authentication Flow with Cookies

### Login with Remember-Me Enabled

1. User submits login credentials with the Remember-Me parameter
2. Authentication succeeds
3. `loginSuccess()` is invoked
4. Remember-Me cookie is generated and sent to the browser

---

### Subsequent Requests Without Session

1. `JSESSIONID` is missing or expired
2. Remember-Me cookie is present
3. `RememberMeAuthenticationFilter` detects the cookie
4. `autoLogin()` is invoked
5. Token is validated
6. UserDetails are loaded
7. Authentication is restored
8. A new `JSESSIONID` is issued

---

## XML Configuration for Cookie-Based Remember-Me

```xml
<http>
    ...
    <remember-me key="myAppKey"/>
</http>
```

If multiple `UserDetailsService` beans exist, use `user-service-ref` to specify the correct one.

---

## Remember-Me Interfaces and Filter Integration

### RememberMeServices Interface

```java
Authentication autoLogin(HttpServletRequest request, HttpServletResponse response);

void loginFail(HttpServletRequest request, HttpServletResponse response);

void loginSuccess(HttpServletRequest request,
                  HttpServletResponse response,
                  Authentication successfulAuthentication);
```

* `loginSuccess()` and `loginFail()` are invoked by authentication filters
* `autoLogin()` is invoked when no authentication exists in the `SecurityContextHolder`

This design allows multiple Remember-Me strategies to coexist.

---

## TokenBasedRememberMeServices

### Responsibilities

* Implements cookie-based Remember-Me
* Generates `RememberMeAuthenticationToken`
* Uses `RememberMeAuthenticationProvider`
* Requires a `UserDetailsService`
* Clears the cookie on logout
* Uses SHA-256 by default for token encoding

---

### Algorithm Flexibility

* Encoding algorithm is embedded in the token
* If no algorithm is specified, SHA-256 is assumed
* Encoding and matching algorithms can differ
* Allows safe algorithm upgrades

---

## Required Beans for Cookie-Based Remember-Me

To fully enable Remember-Me manually, the following beans must exist:

* `RememberMeAuthenticationFilter`
* `TokenBasedRememberMeServices`
* `RememberMeAuthenticationProvider`

Additionally:

* `RememberMeServices` must be set on `UsernamePasswordAuthenticationFilter`
* `RememberMeAuthenticationProvider` must be added to the `AuthenticationManager`
* `RememberMeAuthenticationFilter` must be placed after `UsernamePasswordAuthenticationFilter`

---

## Persistent Token Reminder (Contrast)

* Persistent tokens store data in a database
* Use `PersistentTokenBasedRememberMeServices`
* Require a `PersistentTokenRepository`
* Cookie does **not include the username**
* Provides stronger security guarantees

---

## Lesson Summary

In this lesson, we learned that:

* Cookie-based Remember-Me relies on signed tokens stored in cookies
* Tokens include username, password, expiration time, and a private key
* Customization options allow control over:

  * Token validity duration
  * Cookie security (HTTPS-only)
  * Cookie name
  * Request parameter name
* Secure cookies require HTTPS to function
* Changing defaults helps reduce framework exposure
* Cookie-based Remember-Me trades simplicity for weaker security
* Persistent tokens offer a more secure alternative

---

## Diagram: Cookie-Based Remember-Me Authentication Flow

```
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚      Browser     â”‚
 â”‚ (Client / User)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 1. POST /login
          â”‚    username + password
          â”‚    remember=true
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ UsernamePassword           â”‚
 â”‚ AuthenticationFilter       â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 2. Authenticate credentials
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ AuthenticationManager      â”‚
 â”‚ + AuthenticationProviders  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 3. Authentication SUCCESS
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ RememberMeServices         â”‚
 â”‚ (TokenBasedRememberMeSvc)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 4. loginSuccess()
          â”‚    â†’ Generate token
          â”‚    â†’ Sign with key
          â”‚    â†’ Set expiration
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ HTTP Response              â”‚
 â”‚ Set-Cookie:                â”‚
 â”‚ sticky-cookie=BASE64(...)  â”‚
 â”‚ Secure / HttpOnly          â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 5. Cookie stored in browser
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Browser        â”‚
 â”‚ (Later Visit)    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 6. Request WITHOUT JSESSIONID
          â”‚    BUT WITH remember-me cookie
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ RememberMeAuthentication   â”‚
 â”‚ Filter                     â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 7. autoLogin()
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”
 â”‚ RememberMeServices          â”‚
 â”‚ Validate token              â”‚
 â”‚ - username                  â”‚
 â”‚ - expiration                â”‚
 â”‚ - signature (key + password)â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”˜
          â”‚
          â”‚ 8. Load UserDetails
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ UserDetailsService         â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 9. Create Authentication
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ SecurityContextHolder      â”‚
 â”‚ Authentication restored    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 10. New JSESSIONID issued
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Authenticated   â”‚
 â”‚  User Session    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Key Teaching Notes (for the diagram)

* **Remember-Me cookie is only checked when no session exists**
* `RememberMeAuthenticationFilter` runs **before authorization**
* Token validity depends on:

  * Expiration time
  * Password
  * Secret key
* Secure cookies require **HTTPS**
* Password change immediately invalidates all tokens

---

Below is a **clear, lecture-ready ASCII diagram** showing the **Persistent Token Remember-Me Authentication Flow** in Spring Security.
This complements the cookie-based diagram and highlights **where the database participates**.

---

## Diagram: Persistent Token Remember-Me Authentication Flow

```
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚      Browser     â”‚
 â”‚ (Client / User)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 1. POST /login
          â”‚    username + password
          â”‚    remember=true
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ UsernamePassword            â”‚
 â”‚ AuthenticationFilter        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 2. Authenticate credentials
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ AuthenticationManager       â”‚
 â”‚ + AuthenticationProviders   â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 3. Authentication SUCCESS
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ PersistentTokenBasedRememberMeSvc   â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 4. loginSuccess()
          â”‚    â†’ Generate series + token
          â”‚    â†’ Store in database
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ PersistentTokenRepository  â”‚
 â”‚ (Database Table)           â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 5. HTTP Response
          â”‚    Set-Cookie:
          â”‚    remember-me=
          â”‚    series:token
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Browser        â”‚
 â”‚ Cookie Stored    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 6. Later request WITHOUT session
          â”‚    WITH remember-me cookie
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ RememberMeAuthentication    â”‚
 â”‚ Filter                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 7. autoLogin()
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ PersistentTokenBasedRememberMeSvc   â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 8. Lookup series in DB
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ PersistentTokenRepository  â”‚
 â”‚ Validate token value        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 9. Token VALID?
          â”‚    â”œâ”€ YES â†’ Rotate token
          â”‚    â””â”€ NO  â†’ Possible theft
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Update token in DB          â”‚
 â”‚ (New token value)           â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 10. Load UserDetails
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ UserDetailsService          â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 11. Create Authentication
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ SecurityContextHolder       â”‚
 â”‚ Authentication restored     â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 12. New JSESSIONID issued
          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Authenticated   â”‚
 â”‚  User Session    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Security Characteristics (to explain with the diagram)

### Token Structure (Persistent)

```
Cookie Value:
series : token
```

* **series** â†’ Identifies the login session
* **token** â†’ Rotates on every successful auto-login

---

### Why Persistent Tokens Are More Secure

| Feature                | Cookie-Based | Persistent Token |
| ---------------------- | ------------ | ---------------- |
| Token stored in cookie | Yes          | Yes              |
| Token stored in DB     | No           | Yes              |
| Token rotation         | No           | Yes              |
| Theft detection        | No           | Yes              |
| Username in cookie     | Yes          | No               |

---

### Token Theft Detection

If:

* The **series exists**
* But the **token value does not match**

â¡ Spring Security:

* Assumes token theft
* Deletes all tokens for that user
* Forces re-authentication

---

## Required Components for Persistent Remember-Me

* `PersistentTokenBasedRememberMeServices`
* `PersistentTokenRepository`
* `RememberMeAuthenticationFilter`
* `RememberMeAuthenticationProvider`
* `UserDetailsService`

---

## Teaching Summary

* Persistent Remember-Me **adds a database**
* Tokens are **rotated** after each use
* Stolen cookies are **detected and invalidated**
* This approach is **recommended for production systems**

---

Below is a **complete, production-ready Spring Security configuration** for **Persistent Token Remember-Me authentication**, aligned exactly with the **Persistent Token Remember-Me flow diagram** you requested.

This example uses:

* **Spring Security 6 / 7 style**
* **PersistentTokenBasedRememberMeServices**
* **JdbcTokenRepositoryImpl**
* **Database-backed tokens**
* **Form login**

---

## 1ï¸âƒ£ Database Table (REQUIRED)

Persistent Remember-Me **will not work** without this table.

```sql
CREATE TABLE persistent_logins (
    username VARCHAR(64) NOT NULL,
    series VARCHAR(64) PRIMARY KEY,
    token VARCHAR(64) NOT NULL,
    last_used TIMESTAMP NOT NULL
);
```

---

## 2ï¸âƒ£ PersistentTokenRepository Bean

This handles storing and retrieving tokens from the database.

```java
@Bean
public PersistentTokenRepository persistentTokenRepository(DataSource dataSource) {
    JdbcTokenRepositoryImpl repo = new JdbcTokenRepositoryImpl();
    repo.setDataSource(dataSource);

    // Enable ONLY ONCE if table does not exist
    // repo.setCreateTableOnStartup(true);

    return repo;
}
```

---

## 3ï¸âƒ£ RememberMeServices Bean (CORE)

This is the **heart** of persistent Remember-Me.

```java
@Bean
public PersistentTokenBasedRememberMeServices rememberMeServices(
        UserDetailsService userDetailsService,
        PersistentTokenRepository tokenRepository) {

    PersistentTokenBasedRememberMeServices services =
            new PersistentTokenBasedRememberMeServices(
                    "lssAppKey",
                    userDetailsService,
                    tokenRepository
            );

    services.setTokenValiditySeconds(60 * 60 * 24 * 14); // 14 days
    services.setParameter("remember");                 // checkbox name
    services.setCookieName("persistent-login");        // cookie name
    services.setUseSecureCookie(true);                 // HTTPS only
    services.setAlwaysRemember(false);                 // checkbox required

    return services;
}
```

---

## 4ï¸âƒ£ RememberMeAuthenticationProvider Bean

This provider validates Remember-Me authentication tokens.

```java
@Bean
public RememberMeAuthenticationProvider rememberMeAuthenticationProvider() {
    return new RememberMeAuthenticationProvider("lssAppKey");
}
```

âš ï¸ **The key must match** the one used in `RememberMeServices`.

---

## 5ï¸âƒ£ Security Filter Chain Configuration

This wires everything together.

```java
@Bean
public SecurityFilterChain securityFilterChain(
        HttpSecurity http,
        RememberMeServices rememberMeServices,
        RememberMeAuthenticationProvider rememberMeAuthenticationProvider)
        throws Exception {

    http
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/login", "/css/**", "/js/**").permitAll()
            .anyRequest().authenticated()
        )

        .formLogin(form -> form
            .loginPage("/login")
            .permitAll()
        )

        .rememberMe(remember -> remember
            .rememberMeServices(rememberMeServices)
        )

        .authenticationProvider(rememberMeAuthenticationProvider)

        .logout(logout -> logout
            .logoutUrl("/logout")
            .deleteCookies("persistent-login", "JSESSIONID")
            .permitAll()
        );

    return http.build();
}
```

---

## 6ï¸âƒ£ UserDetailsService (MANDATORY)

Persistent Remember-Me **requires** `UserDetailsService`.

```java
@Bean
public UserDetailsService userDetailsService(UserRepository userRepository) {
    return username -> userRepository.findByUsername(username)
        .orElseThrow(() -> new UsernameNotFoundException("User not found"));
}
```

---

## 7ï¸âƒ£ Login Form (Frontend MUST match)

```html
<form method="post" action="/login">
    <input type="text" name="username" />
    <input type="password" name="password" />

    <label>
        <input type="checkbox" name="remember" />
        Remember me
    </label>

    <button type="submit">Login</button>
</form>
```

---

## 8ï¸âƒ£ What Happens at Runtime (Mapped to Flow)

| Step            | Component                                               |
| --------------- | ------------------------------------------------------- |
| Login success   | `PersistentTokenBasedRememberMeServices.loginSuccess()` |
| Token saved     | `JdbcTokenRepositoryImpl`                               |
| Cookie issued   | `series:token`                                          |
| Session expires | `JSESSIONID` removed                                    |
| Next request    | `RememberMeAuthenticationFilter`                        |
| Token lookup    | Database                                                |
| Token rotated   | New token saved                                         |
| Theft detected  | All tokens deleted                                      |

---

## 9ï¸âƒ£ Why This Is Production-Grade

âœ” Tokens stored server-side
âœ” Token rotation on every login
âœ” Token theft detection
âœ” Password change invalidates tokens
âœ” Works across browser restarts
âœ” HTTPS-only cookie support

---

## ğŸ” Cookie-Based vs Persistent (Quick Reminder)

| Feature              | Cookie-Based | Persistent |
| -------------------- |--------------|------------|
| DB required          | âŒ           | âœ…         | 
| Token rotation       | âŒ           | âœ…         | 
| Theft detection      | âŒ           | âœ…         | 
| Recommended for prod | âŒ           |  âœ…        | 

---

Below is a **clear side-by-side ASCII diagram** comparing
**Cookie-Based Remember-Me** vs **Persistent Token Remember-Me** authentication flows.

You can paste this directly into your lesson notes.

---

# Side-by-Side: Remember-Me Authentication Flows

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        COOKIE-BASED REMEMBER-ME              â”‚    â”‚        PERSISTENT TOKEN REMEMBER-ME          â”‚
â”‚        (Token in Cookie Only)                â”‚    â”‚        (Token Stored in Database)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


1ï¸âƒ£ LOGIN WITH "REMEMBER ME" CHECKED
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚                              â”‚   Browser    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /login                                 â”‚ POST /login
       â”‚ username + password                         â”‚ username + password
       â”‚ remember-me=true                            â”‚ remember-me=true
       â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UsernamePasswordAuth     â”‚              â”‚ UsernamePasswordAuth             â”‚
â”‚ Filter                   â”‚              â”‚ Filter                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ success                                 â”‚ success
           â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenBasedRememberMe     â”‚              â”‚ PersistentTokenBasedRememberMe   â”‚
â”‚ Services                 â”‚              â”‚ Services                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                         â”‚
           â”‚ Create hash-based token                 â”‚ Create (series + token)
           â”‚                                         â”‚
           â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set remember-me cookie   â”‚              â”‚ Save token in DATABASE           â”‚
â”‚ (username + expiry +     â”‚              â”‚ (series, token, last_used)       â”‚
â”‚ signature)               â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
           â”‚                                         â–¼
           â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                              â”‚ Set remember-me cookie           â”‚
           â”‚                              â”‚ (series + token only)            â”‚
           â–¼                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser stores cookie    â”‚
â”‚ (expires ~14 days)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SESSION EXPIRES (JSESSIONID REMOVED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


2ï¸âƒ£ NEXT REQUEST (NO SESSION COOKIE)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚                              â”‚   Browser    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Request with remember-me cookie             â”‚ Request with remember-me cookie
       â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RememberMeAuthentication â”‚              â”‚ RememberMeAuthentication         â”‚
â”‚ Filter                   â”‚              â”‚ Filter                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                         â”‚
           â”‚ Validate token hash                     â”‚ Lookup series in DB
           â”‚                                         â”‚
           â”‚                                         â–¼
           â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                              â”‚ PersistentTokenRepository        â”‚
           â”‚                              â”‚ (JDBC / DB)                      â”‚
           â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                           â”‚
           â”‚                                           â”‚ Validate token
           â”‚                                           â”‚ Rotate token
           â”‚                                           â–¼
           â–¼                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ Issue NEW cookie + update DB     â”‚
â”‚ Auto-authenticate user   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ New JSESSIONID issued    â”‚              â”‚ New JSESSIONID issued            â”‚
â”‚ User remains logged in   â”‚              â”‚ User remains logged in           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SECURITY CHARACTERISTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

COOKIE-BASED                               PERSISTENT TOKEN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Token reusable until expiry             â€¢ Token rotated every login
â€¢ Token usable on any device               â€¢ Token theft detected
â€¢ No server-side state                     â€¢ Server-side validation
â€¢ Password change invalidates token        â€¢ Compromised tokens revoked
â€¢ Simpler                                 â€¢ More secure (RECOMMENDED)


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RECOMMENDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âŒ Cookie-Based â†’ demos, low-risk apps  
âœ… Persistent Token â†’ production systems
```

---



