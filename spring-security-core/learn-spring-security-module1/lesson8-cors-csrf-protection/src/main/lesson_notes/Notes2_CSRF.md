Below is a **focused, end-to-end lesson on CSRF Protection in Spring Security (Spring 6)**, centered on **what CSRF is, why it matters, and how to configure it in a real project**.
This is structured so it can be used **as teaching notes or documentation**, with **clear configuration + project flow**.

---

# CSRF Protection in Spring Security (Spring 6)

**Last Updated:** 23 Jul, 2025

---

## 1. Introduction to CSRF

**CSRF (Cross-Site Request Forgery)** is a web security vulnerability where an attacker tricks an authenticated user’s browser into sending a **malicious request** to a trusted application.

Because browsers automatically send:

* Session cookies
* Authentication cookies

…the server cannot distinguish between:

* A legitimate user request
* A forged request from a malicious site

### Example CSRF Attack

1. User logs into `bank.com`
2. Session cookie is stored in the browser
3. User visits `evil.com`
4. `evil.com` submits a hidden POST request to `bank.com/transfer`
5. Browser sends cookies automatically
6. ❌ Money transferred without user intent

---

## 2. How Spring Security Protects Against CSRF

Spring Security uses a **synchronizer token pattern**:

1. Generate a **CSRF token**
2. Store it on the server
3. Send it to the client
4. Require it on every **state-changing request**

If the token is:

* Missing
* Invalid
* From another session

➡ **Request is rejected with `403 Forbidden`**

---

## 3. Key CSRF Terminologies

### CSRF Attack

An attack that exploits the browser’s automatic credential sending.

### CSRF Token

A **random, unpredictable value** generated by the server.

### CSRF Token Repository

Responsible for:

* Generating
* Storing
* Retrieving
* Validating CSRF tokens

Example:

```java
HttpSessionCsrfTokenRepository
```

### CSRF Token Generation

Occurs when:

* A protected page is accessed
* A session is created

### CSRF Token Validation

Occurs on:

* `POST`
* `PUT`
* `PATCH`
* `DELETE`

---

## 4. When CSRF Protection Is Required

| HTTP Method | CSRF Required |
| ----------- | ------------- |
| GET         | ❌ No          |
| POST        | ✅ Yes         |
| PUT         | ✅ Yes         |
| DELETE      | ✅ Yes         |

Spring Security enforces this **automatically**.

---

## 5. Project Overview (CSRF Demo Application)

### Architecture

* Spring Boot
* Spring Security 6
* Thymeleaf (MVC)
* MongoDB
* Session-based authentication

### Features

* User signup
* User login
* Dashboard (authenticated)
* Logout
* CSRF protection enabled

---

## 6. CSRF Configuration in Spring Security (Core Focus)

### Security Filter Chain Configuration

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .csrf()
            .csrfTokenRepository(csrfTokenRepository())
        .and()
        .authorizeRequests()
            .requestMatchers("/public/**", "/signup", "/login").permitAll()
            .anyRequest().authenticated()
        .and()
        .formLogin()
            .loginPage("/login")
            .permitAll()
        .and()
        .logout()
            .logoutRequestMatcher(new AntPathRequestMatcher("/logout"))
            .permitAll();

    return http.build();
}
```

### CSRF Token Repository

```java
private CsrfTokenRepository csrfTokenRepository() {
    HttpSessionCsrfTokenRepository repository =
            new HttpSessionCsrfTokenRepository();
    repository.setSessionAttributeName("_csrf");
    return repository;
}
```

### Why `HttpSessionCsrfTokenRepository`?

* Secure
* Server-side
* Tied to authenticated session
* Ideal for MVC applications

---

## 7. CSRF Token in HTML Forms (Critical Section)

### Hidden CSRF Input Field

```html
<input type="hidden"
       th:name="${_csrf.parameterName}"
       th:value="${_csrf.token}" />
```

### What Happens Here?

| Attribute             | Purpose                          |
| --------------------- | -------------------------------- |
| `_csrf.parameterName` | Name expected by Spring Security |
| `_csrf.token`         | Unique session token             |

Spring Security:

* Generates the token
* Stores it in session
* Exposes it to Thymeleaf automatically

---

## 8. Thymeleaf Form Handling

### Using `th:action` (Recommended)

```html
<form th:action="@{/login}" method="post">
    <!-- fields -->
</form>
```

✅ CSRF token is **automatically included**
✅ Clean and safe
✅ Best practice for MVC apps

---

### Without `th:action` (Manual)

```html
<form method="post">
    <input type="hidden"
           th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}" />
</form>
```

Required when:

* Using plain HTML
* Custom rendering
* External templates

---

## 9. CSRF Flow (Request Lifecycle)

### Step-by-Step

1. Client requests `/login`
2. Spring Security:

    * Generates CSRF token
    * Saves it in HTTP session
3. Thymeleaf embeds token in HTML
4. User submits form
5. Spring Security:

    * Extracts token from request
    * Compares with session token
6. ✅ Match → Request allowed
   ❌ No match → `403 Forbidden`

---

## 10. CSRF with Signup and Login Forms

### Signup Form

```html
<form th:action="@{/signup}" method="post">
    <input type="hidden"
           th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}" />
    <!-- fields -->
</form>
```

### Login Form

```html
<form th:action="@{/login}" method="post">
    <input type="hidden"
           th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}" />
</form>
```

Both are **protected automatically**.

---

## 11. What Happens If CSRF Is Misconfigured?

| Issue                      | Result       |
| -------------------------- | ------------ |
| CSRF disabled              | ❌ Vulnerable |
| Token missing              | ❌ 403        |
| Token invalid              | ❌ 403        |
| Token from another session | ❌ 403        |

---

## 12. CSRF vs CORS (Clarification)

| Feature            | CSRF                | CORS                      |
| ------------------ | ------------------- | ------------------------- |
| Protects           | Authenticated users | Browser origins           |
| Attack type        | Forged requests     | Unauthorized cross-origin |
| Needed for forms   | ✅ Yes               | ❌ No                      |
| Replaces the other | ❌ No                | ❌ No                      |

➡ **CSRF protects the server**
➡ **CORS protects the browser**

---

## 13. Production Best Practices

### MVC Applications

✅ Enable CSRF (default)
✅ Use session-based tokens
✅ Use POST for logout
✅ Use Thymeleaf `th:action`

### Do NOT

❌ Disable CSRF in form apps
❌ Use CSRF tokens in URLs
❌ Rely on CORS for CSRF protection

---

## 14. Summary

* CSRF is a **server-side protection**
* Spring Security enables it by default
* Tokens are generated, stored, and validated automatically
* Thymeleaf integrates seamlessly
* Your project demonstrates **correct production configuration**

---

# CSRF Protection in Spring Security – Deep Dive

---

## 1. CSRF Token Flow — Sequence Diagram (MVC + Thymeleaf)

### Normal CSRF-Protected Request Flow

```
Browser           Spring MVC            Spring Security
   |                   |                       |
   |  GET /login       |                       |
   |------------------>|                       |
   |                   |---- SecurityFilter -->|
   |                   |     Generate CSRF     |
   |                   |     Store in Session  |
   |                   |<----------------------|
   |                   |                       |
   |<-- HTML + CSRF ---|                       |
   |   (hidden input)  |                       |
   |                   |                       |
   |  POST /login      |                       |
   |  + CSRF token     |                       |
   |------------------>|                       |
   |                   |---- CsrfFilter ------>|
   |                   |  Validate token       |
   |                   |  (session vs request) |
   |                   |<----------------------|
   |                   |                       |
   |<-- 302 /dashboard |                       |
```

### Key Observations

* CSRF token is **generated server-side**
* Token is **stored in session**
* Token is **embedded in HTML**
* Validation occurs **before controller execution**

---

## 2. CSRF Attack vs CSRF-Protected Request

### ❌ CSRF Attack (No Protection)

```
Victim Browser          Evil Site           Target App
      |                    |                   |
      |  Logged in         |                   |
      |------------------->|                   |
      |                    |  Auto POST        |
      |                    |  /transfer        |
      |                    |------------------>|
      |                    |  Cookies sent     |
      |                    |                   |
      |                    |<-- 200 OK --------|
```

### Why the Attack Works

* Browser **automatically sends cookies**
* Server **trusts the cookie**
* No way to verify **user intent**

---

### ✅ CSRF-Protected Request (Spring Security)

```
Victim Browser          Evil Site           Target App
      |                    |                   |
      | Logged in          |                   |
      |------------------->|                   |
      |                    | POST /transfer    |
      |                    |------------------>|
      |                    | Cookies sent      |
      |                    | NO CSRF token     |
      |                    |                   |
      |                    |<-- 403 Forbidden -|
```

### Why the Attack Fails

* Attacker **cannot read CSRF token**
* Token is **session-bound**
* Spring Security **blocks request**

---

## 3. CSRF Protection Decision Matrix

| Scenario          | Cookies  Used | CSRF Needed   |
| ----------------- |---------------|---------------|
| MVC + Session     | ✅ Yes        | ✅ Mandatory  | 
| SPA + Cookies     | ✅ Yes        | ✅ Mandatory  |
| REST + JWT Header | ❌ No         | ❌ Not needed |
| Public GET APIs   | ❌ No         | ❌ Not needed |

---

## 4. MVC CSRF vs REST API CSRF (Spring Security 6)

### Architecture Comparison

| Aspect                  | MVC Application  | REST API     |
| ----------------------- | ---------------- | ------------ |
| Auth mechanism          | Session + Cookie | JWT / OAuth2 |
| CSRF attack surface     | High             | Low          |
| Browser auto cookies    | Yes              | No           |
| CSRF enabled by default | Yes              | Yes          |
| CSRF recommended        | Yes              | Usually No   |

---

## 5. MVC CSRF (Thymeleaf + Sessions)

### Characteristics

* Browser sends session cookie automatically
* Forms submit POST requests
* Vulnerable without CSRF token

### Configuration (Production)

```java
http.csrf(csrf -> csrf
    .csrfTokenRepository(new HttpSessionCsrfTokenRepository())
);
```

### HTML Form

```html
<form th:action="@{/login}" method="post">
    <input type="hidden"
           th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}" />
</form>
```

### Verdict

✅ **Always enable CSRF**
✅ **Default Spring Security behavior is correct**

---

## 6. REST API CSRF (JWT / Token-Based)

### Why CSRF Is Usually Disabled

* Tokens are sent explicitly in headers
* Browser does **not auto-attach Authorization header**
* Attacker cannot forge headers cross-origin

### Typical REST Configuration

```java
http
  .csrf(csrf -> csrf.disable())
  .authorizeHttpRequests(auth -> auth
      .anyRequest().authenticated()
  )
  .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);
```

### REST Request

```
POST /api/orders
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### Verdict

✅ CSRF not required
⚠ Only safe if **cookies are NOT used**

---

## 7. MVC + REST Hybrid Applications (Important)

### Common Mistake ❌

* REST API uses session cookies
* CSRF disabled globally

### Correct Strategy ✅

```java
http
  .csrf(csrf -> csrf
      .ignoringRequestMatchers("/api/**")
  );
```

| Path                              | CSRF     |
| --------------------------------- | -------- |
| `/login`, `/signup`, `/dashboard` | Enabled  |
| `/api/**`                         | Disabled |

---

## 8. Summary Table

| Topic             | Key Takeaway                 |
| ----------------- | ---------------------------- |
| CSRF purpose      | Protects authenticated users |
| CSRF tokens       | Verify user intent           |
| MVC apps          | CSRF is mandatory            |
| REST APIs         | CSRF depends on auth method  |
| Cookies + Browser | CSRF required                |
| JWT + Header      | CSRF optional                |

---

## 9. Final Exam-Ready Statement

> **CSRF protection is required whenever authentication credentials are automatically sent by the browser. Spring Security prevents CSRF attacks by generating, storing, and validating synchronizer tokens on all state-changing requests. MVC applications must enable CSRF, while REST APIs using token-based authentication may safely disable it.**

---

